<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>User Panel - Ads Income Place</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbbvEUnjEnbOPtZJyqL-CUEDy_nAZtGT4",
  authDomain: "hridoy-f9c90.firebaseapp.com",
  databaseURL: "https://hridoy-f9c90-default-rtdb.firebaseio.com",
  projectId: "hridoy-f9c90",
  storageBucket: "hridoy-f9c90.firebasestorage.app",
  messagingSenderId: "378490678321",
  appId: "1:378490678321:web:623f8de0c24dda4dfdb910",
  measurementId: "G-5X6Z7BWTFY"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Telegram WebApp Initialization
const tg = (window.Telegram && window.Telegram.WebApp)?window.Telegram.WebApp:null;
const userName = tg?.initDataUnsafe?.user?.first_name || "Unknown";
const userId = tg?.initDataUnsafe?.user?.id || "unknown_user";
const photoUrl = tg?.initDataUnsafe?.user?.photo_url || "https://telegram.org/img/t_logo.png";

// DOM Content Loaded ‡¶è‡¶∞ ‡¶™‡¶∞‡ßá UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
document.addEventListener('DOMContentLoaded', async ()=>{
    document.getElementById("user-name").innerText = userName;
    document.getElementById("user-photo").src = photoUrl;
    await updateUI();
});

// Default Settings
let REWARD = 0.05;  // Admin ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá
let MIN_WITHDRAW = 100;
let REF_BONUS = 5;
const AD_DURATION = 15;

// Firebase User Data Functions
async function getUserData() {
  const dbRef = ref(db);
  const snapshot = await get(child(dbRef, `users/${userId}`));
  if(snapshot.exists()){
    const data = snapshot.val();
    data.claimedReferrals = data.claimedReferrals || [];
    data.balance = data.balance || 0;
    data.views = data.views || 0;
    data.refCount = data.refCount || 0;
    data.totalWithdrawn = data.totalWithdrawn || 0;
    return data;
  } else {
    const defaultData = { balance:0, views:0, refCount:0, totalWithdrawn:0, claimedReferrals:[] };
    await set(ref(db, `users/${userId}`), defaultData);
    return defaultData;
  }
}

async function saveUserData(data){
  await update(ref(db, `users/${userId}`), data);
}

async function updateUI(){
  const data = await getUserData();
  document.getElementById("balance").innerText = data.balance.toFixed(2);
  document.getElementById("views").innerText = data.views;
  document.getElementById("refCount").innerText = data.refCount;
  document.getElementById("totalWithdrawn").innerText = data.totalWithdrawn.toFixed(2);
}

// Watch Ad
async function watchAd(){
    const watchBtn = document.getElementById('watchBtn');
    const countdownEl = document.getElementById('countdown');

    watchBtn.disabled = true;
    watchBtn.classList.add('muted');
    countdownEl.innerText = `‚è≥ Please wait ${AD_DURATION} seconds...`;

    let remaining = AD_DURATION;
    const timer = setInterval(() => {
        remaining--;
        countdownEl.innerText = `‚è≥ Please wait ${remaining} seconds...`;
        if(remaining <= 0){
            clearInterval(timer);
            completeAd();
        }
    }, 1000);
}

async function completeAd(){
    const data = await getUserData();
    data.balance += REWARD;
    data.views += 1;
    await saveUserData(data);

    document.getElementById('countdown').innerText = `üéâ You earned ${REWARD.toFixed(2)} BDT!`;
    document.getElementById('coinSound').play().catch(()=>{});

    const watchBtn = document.getElementById('watchBtn');
    watchBtn.disabled = false;
    watchBtn.classList.remove('muted');

    updateUI();
}

// Withdraw
window.showWithdraw = function(){
  document.getElementById("withdraw-section").classList.remove("hidden");
  document.getElementById("ad-section").classList.add("hidden");
  document.getElementById("referral-section").classList.add("hidden");
}

window.calculateBDT = function(){
  const amount=parseFloat(document.getElementById("balanceAmount").value)||0;
  document.getElementById("bdtValue").innerText=`You will get: ${amount.toFixed(2)} BDT`;
}

window.submitWithdraw = async function(){
  const method=document.getElementById("method").value;
  const amount=parseFloat(document.getElementById("balanceAmount").value);
  const account=document.getElementById("accountNumber").value.trim();
  const data = await getUserData();

  if(isNaN(amount)||amount<MIN_WITHDRAW){ alert(`Minimum withdraw is ${MIN_WITHDRAW} BDT.`); return;}
  if(!account||account.length<6){ alert("Please enter a valid account number."); return;}
  if(amount>data.balance){ alert("You don't have enough balance."); return;}

  data.balance -= amount;
  data.totalWithdrawn += amount;
  await saveUserData(data);

  document.getElementById("withdraw-section").innerHTML=`
    <h3>‚úÖ Withdraw request submitted!</h3>
    <p>Method: ${method.toUpperCase()}</p>
    <p>Amount: ${amount.toFixed(2)} BDT</p>
    <p>Account Number: ${account}</p>
    <p>We will process your request soon.</p>
    <button class="btn back-btn" onclick="goBack()">üîô Back</button>
  `;
  updateUI();
}

// Referral
window.showReferral = async function(){
  document.getElementById("referral-section").classList.remove("hidden");
  document.getElementById("withdraw-section").classList.add("hidden");
  document.getElementById("ad-section").classList.add("hidden");
  document.getElementById("refLink").innerText=`https://t.me/ads25_income_bot?start=${userId}`;
}

window.copyReferral = function(){
  const ref=document.getElementById("refLink").innerText;
  navigator.clipboard.writeText(ref).then(()=>alert("Referral link copied!")).catch(()=>alert("Copy failed."));
}

window.claimReferralBonus = async function(){
  const code=document.getElementById("claimCode").value.trim();
  const data = await getUserData();
  if(!code){alert("Please enter referral code."); return;}
  if(code==userId){alert("You cannot use your own referral code."); return;}
  if(data.claimedReferrals.includes(code)){alert("You already claimed bonus from this code."); return;}

  data.balance += REF_BONUS;
  data.refCount += 1;
  data.claimedReferrals.push(code);
  await saveUserData(data);

  alert(`üéâ Bonus ${REF_BONUS} BDT added to your balance!`);
  updateUI();
}

window.goBack = function(){
  document.getElementById("withdraw-section").classList.add("hidden");
  document.getElementById("referral-section").classList.add("hidden");
  document.getElementById("ad-section").classList.remove("hidden");
  updateUI();
}
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#4f46e5,#9333ea);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:40px 20px;color:#fff;}
.container{width:100%;max-width:420px;display:flex;flex-direction:column;gap:20px;}
h2{text-align:center;font-size:28px;font-weight:700;margin-bottom:5px;}
.card{backdrop-filter:blur(16px) saturate(180%);-webkit-backdrop-filter:blur(16px) saturate(180%);background:rgba(255,255,255,0.12);border-radius:20px;padding:25px;box-shadow:0 8px 32px rgba(0,0,0,0.25);transition: transform 0.25s ease;}
.card:hover{transform:translateY(-4px);}
.profile{display:flex;flex-direction:column;align-items:center;gap:12px;}
.profile img{width:80px;height:80px;border-radius:50%;border:3px solid #fff;}
.user-name{font-size:20px;font-weight:600;display:flex;align-items:center;gap:6px;}
.verify-icon{color:#00bfff;font-size:18px;}
.premium-icon{color:gold;font-size:18px;}
.info{font-size:15px;margin-top:4px;}
.btn{width:100%;padding:14px;border-radius:12px;border:none;font-size:16px;font-weight:600;cursor:pointer;margin-top:10px;color:#fff;background:linear-gradient(90deg,#7c3aed,#4f46e5);transition:all 0.3s ease;}
.btn:hover{transform:scale(1.03);}
.btn:active{transform:scale(0.98);}
.back-btn{background:linear-gradient(90deg,#374151,#111827);}
#countdown{margin-top:12px;font-size:14px;font-weight:bold;color:#ffeb3b;}
input,select{width:100%;padding:12px;margin:10px 0;border-radius:10px;border:none;outline:none;font-size:15px;}
.hidden{display:none;}
.muted{opacity:0.6;pointer-events:none;}
</style>

<body>
<div class="container">
<h2>üé• ADS INCOME USER PANEL</h2>

<div class="card" id="profile">
<div class="profile">
<img id="user-photo" src="https://telegram.org/img/t_logo.png" alt="Profile">
<div class="user-name"><span class="verify-icon">‚úîÔ∏è</span><span id="user-name">Loading...</span><span class="premium-icon">‚≠ê</span></div>
<div class="info"><b>Balance:</b> <span id="balance">0</span> BDT</div>
<div class="info"><b>Ads Watched:</b> <span id="views">0</span></div>
<div class="info"><b>Referrals:</b> <span id="refCount">0</span></div>
<div class="info"><b>Total Withdrawn:</b> <span id="totalWithdrawn">0</span> BDT</div>
</div>
</div>

<div class="card" id="ad-section">
<button class="btn" id="watchBtn" onclick="watchAd()">üé¨ Watch Ad</button>
<p id="countdown"></p>
</div>

<div class="card">
<button class="btn" onclick="showWithdraw()">üí∏ Withdraw</button>
<button class="btn" onclick="showReferral()">ü§ù Refer</button>
</div>

<div class="card hidden" id="withdraw-section">
<h3>Withdraw Balance</h3>
<select id="method">
<option value="bkash">Bkash</option>
<option value="nagad">Nagad</option>
</select>
<input type="number" id="balanceAmount" placeholder="Enter Amount" oninput="calculateBDT()">
<p id="bdtValue">You will get: 0 BDT</p>
<p style="color:#ffeb3b;font-size:13px;">‚ö†Ô∏è Minimum Withdraw: 100 BDT</p>
<input type="text" id="accountNumber" placeholder="Enter your account number">
<button class="btn" onclick="submitWithdraw()">Submit</button>
<button class="btn back-btn" onclick="goBack()">üîô Back</button>
</div>

<div class="card hidden" id="referral-section">
<h3>Your Referral Link</h3>
<p id="refLink">https://t.me/ads25_income_bot?start=ref</p>
<button class="btn" onclick="copyReferral()">‚òï Copy</button>
<div style="margin-top:15px;">
<h4>Claim Bonus Using Referral Code</h4>
<input type="text" id="claimCode" placeholder="Enter referral code">
<button class="btn" onclick="claimReferralBonus()">Claim Bonus</button>
</div>
<button class="btn back-btn" onclick="goBack()">üîô Back</button>
</div>
</div>

<audio id="coinSound"><source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg"></audio>

</body>
</html>
